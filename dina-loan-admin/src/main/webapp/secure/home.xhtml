<html xmlns="http://www.w3.org/1999/xhtml"   
      xmlns:ui="http://java.sun.com/jsf/facelets" 
      xmlns:h="http://java.sun.com/jsf/html"     
      xmlns:f="http://java.sun.com/jsf/core"  
      xmlns:p="http://primefaces.org/ui"  >

  <body>

    <ui:composition  template="/templates/masterLayout.xhtml">     
      <ui:define name="content"  >   
        <p:ajaxStatus onstart="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()" /> 
        <p:dialog widgetVar="statusDialog" modal="true" draggable="false" closable="false" resizable="false" showHeader="false">   
          <h:panelGrid columns="3"  >  
            <p:graphicImage value="/resources/images/loaderA32.gif"   alt="#{msg.inprocess}" title="#{msg.inprocess}" styleClass="images" /> 
            <p:spacer width="10" />
            <p:outputLabel value="#{msg.inprocess}" styleClass="inprocess" /> 
          </h:panelGrid>  
        </p:dialog> 
        <p:dialog modal="true" widgetVar="statusDialog" header="Status" draggable="false" closable="false" resizable="false">
          <p:graphicImage value="/resources/images/bar90.gif"   styleClass="images" />
        </p:dialog>


        <h:form id="adminform" enctype="multipart/form-data" prependId="false">     
          <!--  top menu   -->
          <!--<h:panelGrid cellpadding="0" cellspacing="0"    >-->  
          <!--<h:panelGrid styleClass="imgswitch" cellpadding="0" cellspacing="0" id="imgswitchPanel"  />--> 
          <h:panelGroup styleClass="main" layout="block" id="mainpanel" 
                        style="min-height: 450px; overflow: auto;">    
            <!-- manage popup -->
            <h:panelGroup  rendered="#{admin.section == 60}">  
              <ui:include src="/secure/portalPopup.xhtml" /> 

              
           
   

            </h:panelGroup>

            <!-- end of popup -->

            <h:panelGroup  rendered="#{admin.section == 0}">  
              <h:panelGroup layout="block" styleClass="centralpanel">  
                <h:panelGroup layout="block" style="padding-left: 120px;">
                  This is the loan request administration page.
                  <br />
                  <br />   
                  <h:panelGrid columns="5" id="vacationpanel">
                    <h:outputText value="On vacation: " />
                    <p:spacer width="5" />  

                    <p:inputSwitch value="#{user.loggedinUser.onvacation}">
                      <p:ajax update="mainpanel" listener="#{user.checkonvacation}" />
                    </p:inputSwitch>

                    <p:spacer width="5" /> 
                    <h:outputText value="Click to activate/deactivate" /> 
                  </h:panelGrid> 
                  <br />
                  <br />   
                  <h:panelGrid style="border: none;" 
                               rendered="#{request.isUserInRole('admin') || request.isUserInRole('manager') || request.isUserInRole('superuser')}">
                    <p:commandLink actionListener="#{admin.manageAccount()}" value="Manage user account"  
                                   process="@this" global="false" update="mainpanel "   styleClass="clink"  />  
                  </h:panelGrid>

                  <h:panelGrid style="border: none;" rendered="#{request.isUserInRole('admin') || request.isUserInRole('manager') || request.isUserInRole('superuser')}">
                    <p:commandLink actionListener="#{admin.manageCollection()}" value="Manage collection"  
                                   process="@this" global="false" update="mainpanel " styleClass="clink"  />  
                  </h:panelGrid>

                  <h:panelGrid style="border: none;" >
                    <p:commandLink actionListener="#{admin.manageLoans()}" value="Manage loan requests"  
                                   process="@this" global="false" update="mainpanel " styleClass="clink"  />  
                  </h:panelGrid>

                  <h:panelGrid style="border: none;" rendered="#{request.isUserInRole('admin') || request.isUserInRole('manager') || request.isUserInRole('superuser')}">
                    <p:commandLink actionListener="#{admin.managePolicyDocuments()}" value="Manage policy documents"  
                                   process="@this" global="false" update="mainpanel " styleClass="clink"  />  
                  </h:panelGrid> 

                  <h:panelGrid style="border: none;" rendered="#{request.isUserInRole('admin') || request.isUserInRole('manager') || request.isUserInRole('superuser')}">
                    <p:commandLink actionListener="#{admin.managePortalPopup()}" value="Manage portal notifications"  
                                   process="@this" global="false" update="mainpanel " styleClass="clink"  />  
                  </h:panelGrid> 
                  <br />
                  <br /> 
                </h:panelGroup> 
              </h:panelGroup>
            </h:panelGroup>

            <!--    manager user account  -->
            <h:panelGroup rendered="#{admin.section == 10}" > 
              <h:panelGroup layout="block" styleClass="subcollectionPanel" id="userAccountPanel">  
                <br /> 
                <p:messages id="userAccountPanelmsg" autoUpdate="true" showDetail="true" showSummary="false" closable="true"  />

                <br /> 

                <h:panelGrid styleClass="userAccountPanel">
                  <p:fieldset legend="Create user account" > 

                    <h:panelGrid columns="3"  id="createUserAccountPanel"  >
                      <p:spacer width="5" />
                      <p:spacer width="5" />
                      <p:spacer width="5" />

                      <h:outputLabel for="username" value="Username: * " />
                      <p:inputText id="username" value="#{user.username}"   required="true" 
                                   requiredMessage="Username is required." size="30" />      
                      <p:message for="username"  />

                      <h:outputLabel for="password" value="Password: * " />
                      <p:password id="password" value="#{user.password}"  required="true" 
                                  requiredMessage="Password is required."  size="30"  />      
                      <p:message for="password"  /> 

                      <h:outputLabel for="email" value="Email: * " />  
                      <p:inputText id="email" required="true"   size="30"
                                   requiredMessage="Email is required."
                                   validatorMessage="Invalid email format"  styleClass="contactfieldstext" 
                                   value="#{user.email}"> 
                        <f:validateRegex pattern="^[_A-Za-z0-9-\+]+(\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9]+)*(\.[A-Za-z]{2,})$" />   
                      </p:inputText> 
                      <p:message for="email"  /> 

                      <h:outputLabel value="Group: * " />
                      <h:selectOneMenu value="#{user.groupname}" >
                        <f:selectItem itemValue="user" itemLabel="User" />	  
                        <f:selectItem itemValue="manager" itemLabel="Manager" /> 
                        <f:selectItem itemValue="admin" itemLabel="Admin" /> 
                      </h:selectOneMenu>
                      <p:spacer width="10" />  

                      <p:spacer width="10" />  
                      <p:spacer width="10" />  
                      <p:spacer width="10" />  

                      <p:spacer width="10" />  
                      <p:spacer width="10" />  
                      <p:commandButton value="Submit" action="#{user.addUserAccount()}" global="true" process="@this,createUserAccountPanel" update="userAccountPanel" />

                      <p:spacer width="10" />  
                      <p:spacer width="10" />  
                      <p:spacer width="10" />  

                      <p:spacer width="10" />  
                      <p:spacer width="10" />  
                      <p:spacer width="10" />    
                    </h:panelGrid>   
                  </p:fieldset> 
                </h:panelGrid> 
                <br />
                <br /> 
                <p:panel styleClass="nobord"  > 
                  <p:dataTable  value="#{user.accounts}"    
                                editable="true" var="account" 
                                emptyMessage="No account found with given criteria" 
                                filteredValue="#{user.filteredAccounts}">

                    <f:facet name="header">
                      Accounts
                    </f:facet>

                    <p:ajax event="rowEdit" listener="#{user.onRowEdit}"  process="@this" global="false" update=":adminform:vacationpanel" /> 

                    <p:column headerText="User name" width="120" filterBy="#{account.username.username}" 
                              footerText="contains" filterMatchMode="contains">
                      <h:outputText value="#{account.username.username}" />
                    </p:column>

                    <p:column headerText="Email" footerText="contains" filterMatchMode="contains"   width="150"  filterBy="#{account.username.email}" >  
                      <p:cellEditor>
                        <f:facet name="output"><h:outputText value="#{account.username.email}" /></f:facet>
                        <f:facet name="input">
                          <p:inputText id="email" required="true"   size="30"
                                       requiredMessage="Email is required."
                                       validatorMessage="Invalid email format"  styleClass="contactfieldstext" 
                                       value="#{account.username.email}"> 
                            <f:validateRegex pattern="^[_A-Za-z0-9-\+]+(\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9]+)*(\.[A-Za-z]{2,})$" />   
                          </p:inputText>  
                        </f:facet>
                      </p:cellEditor>  
                    </p:column>

                    <p:column headerText="Group" footerText="contains" filterMatchMode="contains"   width="120"  filterBy="#{account.groupname}" >  
                      <p:cellEditor>
                        <f:facet name="output"><h:outputText value="#{account.groupname}" /></f:facet>
                        <f:facet name="input"> 
                          <h:selectOneMenu value="#{account.groupname}" >
                            <f:selectItem itemValue="user" itemLabel="User" />	   	
                            <f:selectItem itemValue="manager" itemLabel="Manager" /> 
                            <f:selectItem itemValue="admin" itemLabel="Admin" /> 
                          </h:selectOneMenu>
                        </f:facet>
                      </p:cellEditor>  
                    </p:column>


                    <p:column headerText="On vacation"  width="50" >  
                      <p:cellEditor>
                        <f:facet name="output"><p:selectBooleanCheckbox value="#{account.username.onvacation}"  disabled="true"/></f:facet>
                        <f:facet name="input"><p:selectBooleanCheckbox value="#{account.username.onvacation}" /></f:facet>
                      </p:cellEditor>  
                    </p:column>

                    <p:column style="width:32px"  >
                      <p:rowEditor   />
                    </p:column> 

                    <p:column styleClass="alignTop" style="width: 20px; font-size: 12px;">   
                      <p:commandLink update=":adminform:userAccountPanel" title="Remove" disabled="#{account.groupname == 'admin' || account.groupname == 'superuser'}"
                                     process="@this" action="#{user.removeAccount(account)}" global="false"  >   
                        <p:graphicImage value="/resources/images/button_remove.gif"  styleClass="images" />
                        <p:collector value="#{account}"  removeFrom="#{user.accounts}" unique="true"   />  
                      </p:commandLink>  
                    </p:column>  
                  </p:dataTable>   
                </p:panel> 
              </h:panelGroup>  
            </h:panelGroup>  



            <!--    manager collection  -->
            <h:panelGroup rendered="#{admin.section == 20}" layout="block">  
              <h:panelGroup layout="block" id="subcollectionPanel" styleClass="subcollectionPanel text" >  
                <h:panelGrid>
                  <p:selectOneMenu value="#{admin.department}" id="contact1title" style="width:185px; font-size:  11px; font-family: Arial,sans-serif;">  
                    <f:selectItem itemValue="Botany" itemLabel="Botany" itemDisabled="true" />
                    <f:selectItem itemValue="Environmental Specimen Bank" itemLabel="Environmental Specimen Bank" itemDisabled="true" />
                    <f:selectItem itemValue="Geology" itemLabel="Geology" itemDisabled="true" />
                    <f:selectItem itemValue="Palaeobiology" itemLabel="Palaeobiology" itemDisabled="true" />
                    <f:selectItem itemValue="Zoology" itemLabel="Zoology" /> 
                    <p:ajax listener="#{admin.departmentChanged}" update="subcollectionPanel" global="false" />
                  </p:selectOneMenu>    
                </h:panelGrid>

                <br />
                <br /> 

                <p:accordionPanel  dynamic="true" cache="true"  id="accordionCollectionPanel" >

                  <p:ajax event="tabChange" listener="#{admin.onTabChange}" />

                  <p:tab title="Edit Non scientific loans"  > 
                    <h:panelGroup layout="block">
                      <h:outputLabel for="ungroupedManager" value="Manager for non-scientific loans [Click on the text to edit]: " 
                                     styleClass="defaultboldtext" />
                      <br />
                    </h:panelGroup>
                    <h:panelGrid cellpadding="0" cellspacing="0" columns="4" id="nonScientificPanel" 
                                 columnClasses="cgcol2,cgcol,cgcol2,cgcol5"> 
                      <p:spacer width="10" />
                      <p:inplace id="ungroupedManager">
                        <p:inputText value="#{admin.nonScientificLoansManager}"  required="true"  id="nonScientificManagerEmail"
                                     requiredMessage="Manager's email can not be empty!" size="40"
                                     validatorMessage="Invalid email address!"  styleClass="contactfieldstext" >
                          <f:validateRegex pattern="^[_A-Za-z0-9-\+]+(\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9]+)*(\.[A-Za-z]{2,})$" /> 
                        </p:inputText> 
                      </p:inplace>  
                      <p:spacer width="20" /> 
                      <h:panelGrid style="padding-left: 20px; vertical-align: top;">
                        <p:commandButton value="Update" process="@this,nonScientificPanel" 
                                         update=":adminform:subcollectionPanel" 
                                         actionListener="#{admin.updateNonScientificManager}" />
                      </h:panelGrid> 
                      <p:spacer width="10" />
                      <p:message for="nonScientificManagerEmail" /> 
                    </h:panelGrid>
                  </p:tab>
                  <p:tab title="Edit Relevent Collection"  > 
                    <h:panelGrid   cellpadding="0" cellspacing="0" id="changeGroupNamePanel">

                      <h:panelGrid columns="4"  columnClasses="cgcol1,cgcol2,cgcol3,cgcol" > 
                        <h:outputLabel for="collection" value="Collection: " styleClass="defaultboldtext" />
                        <p:spacer width="10" />
                        <h:outputLabel for="manager" value="Manager: " styleClass="defaultboldtext" />
                        <h:outputText value="[Click on the text to edit]" styleClass="defaultboldtext"/>  
                      </h:panelGrid>

                      <p:messages id="editCollectionPanelmsg" autoUpdate="true"  showDetail="true" 
                                  showSummary="false" closable="true" rendered="#{admin.activeTab == 1}"  /> 

                      <ui:repeat var="cm" value="#{admin.cmList}" varStatus="status">
                        <h:panelGrid columns="7" id="collectionManagerEditPanel" 
                                     columnClasses="cgcol1,cgcol2,cgcol3,cgcol4,cgcol5" > 
                          <p:inplace id="collection">
                            <p:inputText value="#{cm.newGroupName}"  required="true"  requiredMessage="Collection name can not be empty!" />
                          </p:inplace>  

                          <p:spacer width="10" />
                          <p:inplace id="manager">
                            <p:inputText value="#{cm.manager}" size="30" required="true"  requiredMessage="Manager's email can not be empty!" />
                          </p:inplace>

                          <p:outputLabel value="&lt;==&gt;" style="color: #0b5e82; "  /> 
                          <p:commandButton value="Update" process="@this,collectionManagerEditPanel" 
                                           update=":adminform:subcollectionPanel" 
                                           actionListener="#{admin.updateCollection(cm)}" />
                          <p:spacer width="5" />  
                          <p:commandButton value="Remove (Remove whole collection)" actionListener="#{admin.removeCollection(cm)}" 
                                           update=":adminform:subcollectionPanel" process="@this,collectionManagerEditPanel"   >
                            <p:confirm header="Confirmation" message="This will delete whole collection. Are you sure?" 
                                       icon="ui-icon-alert" /> 
                          </p:commandButton>
                        </h:panelGrid> 
                      </ui:repeat>



                      <p:confirmDialog global="true" showEffect="fade" hideEffect="explode">
                        <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" style="color:   #FFFFFF;"   />
                        <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" style="color:   #FFFFFF;"   />
                      </p:confirmDialog>

                      <br />
                      <br />

                      <ui:repeat var="map" value="#{admin.map.keySet().toArray()}" varStatus="status">  

                        <p:dataTable   var="c" value="#{admin.map.get(map) }" editable="true" style="margin-bottom:20px"  >
                          <f:facet name="header">
                            #{map} (Collection manager: #{admin.managermail(map)}   ) 
                          </f:facet>

                          <p:ajax event="rowEdit" listener="#{admin.onRowEdit}"   />
                          <p:ajax event="rowEditCancel" listener="#{admin.onRowCancel}"  />

                          <p:column headerText="Collection name">
                            <p:cellEditor>
                              <f:facet name="output"><h:outputText value="#{c.name}" /></f:facet>
                              <f:facet name="input"><p:inputText  value="#{c.name}" style="width:100%"/></f:facet>
                            </p:cellEditor>
                          </p:column>

                          <p:column headerText="Curator's email">
                            <p:cellEditor>
                              <f:facet name="output"><h:outputText value="#{c.email}" /></f:facet>
                              <f:facet name="input"><p:inputText value="#{c.email}" style="width:100%"/></f:facet>
                            </p:cellEditor>
                          </p:column>

                          <p:column style="width:32px">
                            <p:rowEditor />
                          </p:column>

                          <p:column styleClass="alignTop" style="width: 20px; font-size: 12px;">   
                            <p:commandLink update=":adminform:subcollectionPanel" title="Remove" 
                                           process="@this" action="#{admin.removeSubCollection(c)}" global="false"  >   
                              <p:graphicImage value="/resources/images/button_remove.gif" styleClass="images" />
                              <p:collector value="#{c}"  removeFrom="#{admin.map.get(map)}" unique="true"   />  
                            </p:commandLink>  
                          </p:column>  
                        </p:dataTable>  
                        <br />
                        <br /> 
                        <br /> 
                      </ui:repeat>    
                    </h:panelGrid>
                  </p:tab>

                  <p:tab title="Create New Relevent Collection"> 

                    <!--<p:messages id="newCollectionPanelmsg" showDetail="true" showSummary="false" closable="true" />-->

                    <h:panelGrid columns="3"  id="createNewCollectionPanel"> 
                      <h:outputLabel for="newCollectionName" value="Collection Name: " />
                      <p:inputText id="newCollectionName" value="#{admin.newCollectionName}" size="30"
                                   required="true" requiredMessage="Collection name is required." />
                      <p:message for="newCollectionName"   />

                      <h:outputLabel for="newCurator" value="Curator's email: " />
                      <p:inputText id="newCurator" value="#{admin.newCollectionCurator}" size="30"
                                   required="true"  requiredMessage="Curator email is required." />
                      <p:message for="newCurator"   />


                      <h:outputText value="Collection group :" />  
                      <p:selectOneMenu id="newGroupName" value="#{admin.newCollectionGroupName}" 
                                       editable="true"  style="width:185px; font-size:  11px; font-family: Arial,sans-serif;"> 
                        <f:selectItems value="#{admin.collectionGroupNames}"  /> 
                        <p:ajax listener="#{admin.addNewCollection}" update="@this,newManager" global="false" process="@this"/> 
                      </p:selectOneMenu>
                      <p:spacer width="10" />

                      <h:outputLabel for="newManager" value="Collection manager's email: " />
                      <p:inputText id="newManager" value="#{admin.newCollectionManager}" size="30" required="true" 
                                   requiredMessage="Collection manager's email is required." disabled="#{admin.managerDisable}" />
                      <p:message for="newManager"   />

                      <p:spacer width="10" />
                      <p:spacer width="10" />
                      <h:panelGrid style="width: 200px; float: right;">
                        <p:commandButton value="Save collection" action="#{admin.saveNewCollection}"  
                                         update=":adminform:subcollectionPanel" global="false" process="createNewCollectionPanel" />
                      </h:panelGrid>

                    </h:panelGrid>
                  </p:tab> 
                </p:accordionPanel> 
              </h:panelGroup> 
            </h:panelGroup> 





            <!--    manager loans  -->
            <h:panelGroup rendered="#{admin.section == 30}" layout="block">
              <h:panelGroup layout="block" id="loansPanel" styleClass="loanspanel" > 
                <h:panelGrid style="text-align: center; margin-left: auto; margin-right: auto; ">
                  <h1>Loan Request Handling</h1>
                </h:panelGrid>

                <br /> 
                <p:accordionPanel>
                  <p:tab title="Loan filters">

                    <h:panelGrid id="departmentcheckboxpanel" columns="7" columnClasses="alignTop,alignTop,alignTop,alignTop,alignTop,alignTop,alignTop">  
                      <p:fieldset legend="Select departments" styleClass="queryfieldset"> 
                        <p:selectManyCheckbox id="departmentCheckBox" value="#{search.selectedDepartments}" layout="pageDirection">
                          <f:selectItem itemValue="All" itemLabel="All departments"  itemDisabled="true"   />
                          <f:selectItem itemValue="Botany" itemLabel="Botany" itemDisabled="true"  />
                          <f:selectItem itemValue="Environmental Specimen Bank" itemLabel="Environmental Specimen Bank"  itemDisabled="true" />
                          <f:selectItem itemValue="Geology" itemLabel="Geology"  itemDisabled="true" />
                          <f:selectItem itemValue="Palaeobiology" itemLabel="Palaeobiology"  itemDisabled="true" />
                          <f:selectItem itemValue="Zoology" itemLabel="Zoology"   />  

                          <p:ajax listener="#{search.filterLoansByDepartment}" update=":adminform:loansPanel"  />
                        </p:selectManyCheckbox>
                      </p:fieldset>

                      <p:spacer width="10" />


                      <p:fieldset legend="Select purpose of loans" styleClass="queryfieldset"> 
                        <p:selectManyCheckbox id="purposeCheckBox" value="#{search.selectedPurposes}" layout="pageDirection">
                          <f:selectItem itemValue="All" itemLabel="All purposes"   />
                          <f:selectItem itemValue="Scientific purpose" itemLabel="Scientific"   />
                          <f:selectItem itemValue="Education/Exhibition" itemLabel="Education / Exhibition"   />
                          <f:selectItem itemValue="Commercial/art/other" itemLabel="Commercial / Art / Other"   /> 

                          <p:ajax listener="#{search.filterLoansByPurpose()}" update=":adminform:loansPanel "  />
                        </p:selectManyCheckbox>
                      </p:fieldset>

                      <p:spacer width="10" />

                      <p:fieldset legend="Select type of loans" styleClass="queryfieldset"> 
                        <p:selectManyCheckbox id="typeCheckBox" value="#{search.selectedTypes}" layout="pageDirection">
                          <f:selectItem itemValue="All" itemLabel="All types"   />
                          <f:selectItem itemValue="Physical" itemLabel="Physical"   />
                          <f:selectItem itemValue="Photo" itemLabel="Photo"   /> 
                          <f:selectItem itemValue="Information" itemLabel="Infomation"   /> 
                          <p:ajax listener="#{search.filterLoansByType}" update=":adminform:loansPanel " />
                        </p:selectManyCheckbox>
                      </p:fieldset>

                      <p:spacer width="10" />

                      <p:fieldset legend="Select date range" styleClass="queryfieldset"> 

                        <h:selectOneRadio id="dateRadio" value="#{search.dateForSearch}">
                          <f:selectItem itemValue="submitDate" itemLabel="Date requested" />   
                          <f:selectItem itemValue="closeDate" itemLabel="Date request closed"/>      
                          <p:ajax event="valueChange" listener="#{search.dateSearch}" update=":adminform:loansPanel "/>  
                        </h:selectOneRadio>
                        <br /> 
                        <h:panelGrid columns="3" id="calPanel"> 
                          <p:calendar pattern="yyyy-MM-dd" showButtonPanel="true" navigator="true"  size="15"
                                      id="fromdate" value="#{search.fromDate}" pages="3" 
                                      maxdate="#{search.maxDate}"     >  
                            <p:ajax event="dateSelect" listener="#{search.handleDateSelect}" update="calPanel :adminform:loansPanel" />  
                          </p:calendar> 
                          <h:outputText value=" -- " />
                          <p:calendar pattern="yyyy-MM-dd" showButtonPanel="true" navigator="true"  size="15"
                                      id="todate" value="#{search.toDate}" pages="3" 
                                      maxdate="#{search.maxDate}" mindate="#{search.mindate}"    >    

                            <p:ajax event="dateSelect" listener="#{search.dateSearch}" update=":adminform:loansPanel" />  
                          </p:calendar> 
                          <h:outputText value="From" />
                          <p:spacer width="10" />
                          <h:outputText value="To" /> 
                        </h:panelGrid>  
                      </p:fieldset>

                      <p:spacer width="10" />
                      <p:spacer width="10" />
                      <p:spacer width="10" />
                      <p:spacer width="10" />
                      <p:spacer width="10" />
                      <p:spacer width="10" />
                      <p:spacer width="10" /> 
                    </h:panelGrid>
                  </p:tab>
                </p:accordionPanel>                  
                <p:dataTable  id="loans" var="loan" value="#{search.loans}"  rows="10" editable="true"  widgetVar="loanTable"
                              paginator="true" emptyMessage="No loans found with given criteria" 
                              paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                              rowsPerPageTemplate="10,25,50,100"  
                              currentPageReportTemplate="Showing {startRecord}-{endRecord} out of {totalRecords}" 
                              rowStyleClass="#{styleBean.loanRowColor(loan.status)}" 
                              filteredValue="#{search.filteredLoans}"  
                              scrollable="true" scrollWidth="100%" styleClass="fixed-size" 
                              > 
                  <f:facet name="header"> 
                    Loans   
                    <p:outputPanel style="padding-left: 10px; width: 100%; float: left; text-align: left; ">
                      <h:outputText value="Search all fields:" />
                      <p:spacer width="20" />
                      <p:inputText id="globalFilter" onblur="PF('loanTable').filter()"  size="40"   placeholder="Enter keyword"/> 

                      <p:spacer width="30" height="5" />
                      <p:commandButton value="Search" actionListener="#{search.refreshLoans}" update="loans" />
                    </p:outputPanel> 
                  </f:facet>

                  <p:ajax event="rowEdit" listener="#{search.onRowEdit(loan)}"    /> 

                  <p:column style="min-width:16px">
                    <p:rowToggler />
                  </p:column>

                  <p:column style="min-width:32px">
                    <p:rowEditor />
                  </p:column>

                  <p:column headerText="Request Number" style="min-width:130px" sortBy="#{loan.id}" filterBy="#{loan.id}" footerText="contains" filterMatchMode="contains">
                    <h:outputText value="#{loan.id}" />
                  </p:column>

                  <p:column headerText="Status" style="min-width:130px"  sortBy="#{loan.status}" filterBy="#{loan.status}" 
                            filterOptions="#{search.statusOptions}"  
                            footerText="exact"   filterMatchMode="exact" >  

                    <p:cellEditor>
                      <f:facet name="output"><h:outputText value="#{loan.status}" /></f:facet>
                      <f:facet name="input">
                        <p:selectOneMenu value="#{loan.status}" effect="fold" style="width: 120px; ">
                          <f:selectItems value="#{search.statusList}" />
                        </p:selectOneMenu> 
                      </f:facet>
                    </p:cellEditor>
                  </p:column>

                  <p:column headerText="Curator" style="min-width:200px"   sortBy="#{loan.curator}" filterBy="#{loan.curator}" 
                            filterOptions="#{search.curatorOptions}"  
                            footerText="exact"   filterMatchMode="exact" >  

                    <p:cellEditor>
                      <f:facet name="output"><h:outputText value="#{loan.curator}" /></f:facet>
                      <f:facet name="input">
                        <p:selectOneMenu  value="#{loan.curator}" effect="fold" editable="true" style="width: 200px; ">
                          <f:selectItem itemLabel="Select One" itemValue="" />
                          <f:selectItems value="#{search.curators}" />
                        </p:selectOneMenu> 
                      </f:facet>
                    </p:cellEditor>
                  </p:column>


                  <p:column headerText="Relevent Collection" style="min-width:180px"   sortBy="#{loan.releventCollection}" filterBy="#{loan.releventCollection}" 
                            filterOptions="#{search.collectionOptions}"  
                            footerText="exact"   filterMatchMode="exact" >  

                    <p:cellEditor>
                      <f:facet name="output"><h:outputText value="#{loan.releventCollection}" /></f:facet>
                      <f:facet name="input">
                        <p:selectOneMenu  value="#{loan.releventCollection}" effect="fold" style="width: 180px; " >
                          <f:selectItems value="#{search.collections}" />
                        </p:selectOneMenu>   
                      </f:facet>
                    </p:cellEditor>
                  </p:column>

                  <p:column headerText="Borrower" style="min-width:150px" sortBy="#{loan.borrower}"  filterBy="#{loan.borrower}" footerText="contains" filterMatchMode="contains">
                    <h:outputText value="#{loan.borrower}" />
                  </p:column>

                  <p:column headerText="2ndry Borrower"  style="min-width:150px" sortBy="#{loan.secondaryBorrower}"  filterBy="#{loan.secondaryBorrower}" footerText="contains" filterMatchMode="contains">
                    <h:outputText value="#{loan.secondaryBorrower}" />
                  </p:column>

                  <p:column headerText=" Date Request"  style="min-width:130px" sortBy="#{loan.submitDate}" > 
                    <h:outputText value="#{loan.submitDate}" /> 
                  </p:column>

                  <p:column headerText="Request Closed"  style="min-width:130px" sortBy="#{loan.closeDate}"  >  
                    <h:outputText value="#{loan.closeDate}" />  
                  </p:column>

                  <p:column headerText="Comments" style="min-width:130px"   sortBy="#{loan.comments}" filterBy="#{loan.comments}" footerText="contains"   filterMatchMode="contains" >  
                    <p:cellEditor>
                      <f:facet name="output"><h:outputText value="#{loan.comments}" /></f:facet>
                      <f:facet name="input">
                        <p:inputText value="#{loan.comments}" style="width:100%" label="Comments"/>
                      </f:facet>
                    </p:cellEditor>
                  </p:column>

                  <p:column headerText="Loan Number"  style="min-width:130px" sortBy="#{loan.loanNumber}" filterBy="#{loan.loanNumber}" footerText="contains"   filterMatchMode="contains" >  
                    <p:cellEditor>
                      <f:facet name="output"><h:outputText value="#{loan.loanNumber}" /></f:facet>
                      <f:facet name="input">
                        <p:inputText value="#{loan.loanNumber}" style="width:100%" label="Loan Number"/>
                      </f:facet>
                    </p:cellEditor>
                  </p:column> 
                  <p:rowExpansion> 
                    <p:panel header="Request Summary PDF" styleClass="nobord"> 
                      <h:panelGroup layout="block">
                        <h:outputText value="Attachments: " styleClass="defaultboldtext" />
                        <br />
                        <br />
                        <h:panelGroup layout="block"  rendered="#{not empty loan.loanDescriptionFile}">
                          <h:outputText value="Description of the loan:  " /> 
                          <h:outputText value="  #{loan.loanDescriptionFile}  " /> 
                          <p:commandLink value="Download" actionListener="#{download.downloadDescriptionfile(loan)}" 
                                         ajax="false" onclick="PrimeFaces.monitorDownload(start, stop);" >
                            <p:fileDownload value="#{download.file}" />
                          </p:commandLink> 
                          <br />
                          <br />
                        </h:panelGroup> 

                        <h:panelGroup layout="block"  rendered="#{not empty loan.photoInstractionFile}"> 
                          <h:outputText value="Photo instruction:  " /> 
                          <h:outputText value="   #{loan.photoInstractionFile}  " /> 
                          <p:commandLink value="Download" actionListener="#{download.downloadPhotoInstractionFile(loan)}" 
                                         ajax="false" onclick="PrimeFaces.monitorDownload(start, stop);" >
                            <p:fileDownload value="#{download.file}" />
                          </p:commandLink> 
                          <br />
                          <br />
                        </h:panelGroup> 

                        <h:panelGroup layout="block"  rendered="#{not empty loan.edPurposeFile}">

                          <h:outputText value="Photo instruction:   " style="padding-right: 10px;" />
                          <h:outputText value="  #{loan.edPurposeFile}  " style="padding-right: 10px;" />

                          <p:commandLink value="Download" actionListener="#{download.downloadEdPurposeFile(loan)}" 
                                         ajax="false" onclick="PrimeFaces.monitorDownload(start, stop);" >
                            <p:fileDownload value="#{download.file}" />
                          </p:commandLink> 
                          <br />
                          <br />
                        </h:panelGroup> 


                        <h:panelGroup layout="block"  rendered="#{not empty loan.destructiveFile}"> 
                          <h:outputText value="Destructive samplening instruction:   " style="padding-right: 10px;" />
                          <h:outputText value="  #{loan.destructiveFile}  " style="padding-right: 10px;" />

                          <p:commandLink value="Download" actionListener="#{download.downloadDestructivefile(loan)}" 
                                         ajax="false" onclick="PrimeFaces.monitorDownload(start, stop);" >
                            <p:fileDownload value="#{download.file}" />
                          </p:commandLink> 
                          <br />
                          <br />
                        </h:panelGroup> 




                        <h:panelGroup layout="block"  rendered="#{loan.purpose=='Scientific purpose'}" > 
                          <h:outputText value="Download file:   " style="padding-right: 10px;" /> 


                          <p:dataTable id="tbl" var="sample" value="#{loan.samples}"  
                                       rows="5"
                                       paginator="true" style="width: 880px;">
                            <f:facet name="footer" >  
                              <h:commandLink>
                                <p:graphicImage value="/resources/images/excel.png" title="Excel" styleClass="images"/>
                                <p:dataExporter type="xls" target="tbl" fileName="loan" />
                              </h:commandLink>
                              <h:commandLink >
                                <p:graphicImage value="/resources/images/csv.png"  alt="CSV"  title="CSV" styleClass="images"/>     
                                <p:dataExporter type="csv" target="tbl" fileName="loan" />
                              </h:commandLink> 
                              <p:spacer width="700" height="5"/>

                            </f:facet>


                            <p:column style="font-size: 11px;  " width="110">
                              <f:facet name="header">
                                <h:outputText value="Cat. no" />
                              </f:facet>
                              <h:outputText value="#{sample.catalogNumber}" />
                            </p:column>

                            <p:column style="font-size: 11px; "  width="80" >
                              <f:facet name="header">
                                <h:outputText value="Family"/>
                              </f:facet>
                              <h:outputText value="#{sample.family}" />
                            </p:column>

                            <p:column style="font-size: 11px; "  width="80" >
                              <f:facet name="header">
                                <h:outputText value="Genus"/>
                              </f:facet>
                              <h:outputText value="#{sample.genus}" />
                            </p:column>


                            <p:column style="font-size: 11px; "  width="140" >
                              <f:facet name="header">
                                <h:outputText value="Species"/>
                              </f:facet>
                              <h:outputText value="#{sample.species}" />
                            </p:column>

                            <p:column style="font-size: 11px; " width="100" >
                              <f:facet name="header">
                                <h:outputText value="Author"/>
                              </f:facet>
                              <h:outputText value="#{sample.auctor}" />
                            </p:column>

                            <p:column style="font-size: 11px; " width="60"  >
                              <f:facet name="header">
                                <h:outputText value="Type status"/>
                              </f:facet>
                              <h:outputText value="#{sample.typeStatus}" />
                            </p:column>

                            <p:column style="font-size: 11px; " width="60"  >
                              <f:facet name="header">
                                <h:outputText value="Type"/>
                              </f:facet>
                              <h:outputText value="#{sample.type}" />
                            </p:column>

                            <p:column style="font-size: 11px;  " width="180" >
                              <f:facet name="header">
                                <h:outputText value="Storage"/>
                              </f:facet>
                              <h:outputText value="#{sample.location}" />
                            </p:column> 
                          </p:dataTable> 
                        </h:panelGroup> 
                        <br /> 
                      </h:panelGroup>  
                      <ui:remove>
                        <object type="application/pdf" data="#{admin.pdf(loan)}" height="750px" width="820px"  /> 
                      </ui:remove>
                      <p:media value="#{admin.pdf(loan)}" height="750px" width="820px"  player="pdf">
                        Your browser can't display pdf, <h:outputLink
                          value="#{admin.pdf(loan)}">click</h:outputLink> to download pdf instead.
                      </p:media>
                    </p:panel> 
                  </p:rowExpansion> 
                </p:dataTable>   
              </h:panelGroup> 
            </h:panelGroup>


            <h:panelGroup rendered="#{admin.section == 40}" layout="block">
              <h:panelGroup layout="block" styleClass="policypanel" id="policyPanel">
                <p:panel header="Update Loan policy documents" styleClass="nobord">
                  <br />
                  <h:panelGrid id="updatePolicyPanel" rendered="#{admin.isNewPolicy}">
                    <h:outputText value="Right click here to update new policy files"  style="color: #FF0000; "/>
                  </h:panelGrid>

                  <p:contextMenu for="updatePolicyPanel"> 
                    <p:menuitem value="Update" update="policyPanel" icon="ui-icon-refresh" actionListener="#{admin.updatePolicy}" oncomplete="window.location.reload();"/>
                  </p:contextMenu>
                  <br />
                  <br />  
                  <p:commandButton id="currentScPolicyBtn"  value="Current loan policy for scientific purpose" type="button"  />
                  <ui:remove>
                    <p:overlayPanel id="currentScPolicyPanel" for="currentScPolicyBtn" hideEffect="fade" dynamic="true"  >
                      <object type="application/pdf" data="#{admin.scPolicy}" height="750px" width="800px"    /> 
                    </p:overlayPanel> 
                  </ui:remove>

                  <p:overlayPanel id="currentScPolicyPanel1" for="currentScPolicyBtn" hideEffect="fade" dynamic="true"  >
                    <p:media value="#{admin.scPolicy}" height="750px" width="800px"  player="pdf">
                      Your browser can't display pdf, <h:outputLink
                        value="#{admin.scPolicy}">click</h:outputLink> to download pdf instead.
                    </p:media>
                  </p:overlayPanel> 


                  <br />
                  <br />  
                  <br />
                  <br />  
                  <h:panelGrid styleClass="text" id="scpolicyfilePanel"> 
                    <h:outputText value="Upload loan policy for scientific purpose: " styleClass="defaultboldtext" />
                    <br />  
                    <h:outputText value="(Drag and drop file into upload box, or select file from file system.)" styleClass="smalltext" />
                    <br /> 
                    <p:fileUpload fileUploadListener="#{admin.uploadScFile}" mode="advanced"
                                  allowTypes="/(\.|\/)(pdf)$/" styleClass="originalbutton" update="policyPanel" />  
                  </h:panelGrid>

                  <br />
                  <br />
                  <br /> 
                  <p:commandButton id="currentEdPolicyBtn" value="Current loan policy for educational purpose" type="button" />
                  <ui:remove>
                    <p:overlayPanel id="currentEdPolicyPanel" for="currentEdPolicyBtn" hideEffect="fade" dynamic="true"  >
                      <object type="application/pdf" data="#{admin.edPolicy}" height="750px" width="800px"  />  
                    </p:overlayPanel>
                  </ui:remove>
                  <p:overlayPanel id="currentEdPolicyPanel" for="currentEdPolicyBtn" hideEffect="fade" dynamic="true"  >
              
                    <p:media value="#{admin.edPolicy}" height="750px" width="800px"  player="pdf">
                      Your browser can't display pdf, <h:outputLink
                        value="#{admin.edPolicy}">click</h:outputLink> to download pdf instead.
                    </p:media>
                  <br /> 
                  </p:overlayPanel>
                 
                  <br />  
                  <br />
                  <br />  
                  <h:panelGrid styleClass="text" id="edpolicyfilePanel">   
                    <h:outputText value="Upload loan policy for educational purpose: "  styleClass="defaultboldtext" /> 
                    <br />
                    <h:outputText value="(Drag and drop file into upload box, or select file from file system.)" styleClass="smalltext" />
                    <br /> 

                    <p:fileUpload fileUploadListener="#{admin.uploadEdFile}" mode="advanced"
                                  allowTypes="/(\.|\/)(pdf)$/" styleClass="originalbutton" update="policyPanel"  />  
                  </h:panelGrid>
                </p:panel>

              </h:panelGroup> 
            </h:panelGroup>

            <h:panelGroup rendered="#{admin.section == 50}" layout="block" id="userProfilePanel">
              <h:panelGrid  styleClass="profilepanel"> 

                <p:messages id="changePasswordSuccessMsg" autoUpdate="true" showDetail="true"  
                            showSummary="false" closable="true"   showIcon="true" 
                            rendered="#{user.isChangePasswordSuccessed}"  />

                <p:messages id="changePasswordErrorMsg" autoUpdate="true" showDetail="true"  showSummary="false" closable="true"   showIcon="true" rendered="#{!user.isChangePasswordSuccessed}"  />
                <h:panelGrid columns="4" style="padding-left: 20px; " cellpadding="0" cellspacing="0" id="changePasswordPanel" 
                             rendered="#{!user.isChangePasswordSuccessed}" > 
                  <p:outputLabel value="Old password:  "  class="labeltext" for="oldPassword" />
                  <p:spacer width="10" />
                  <p:password value="#{user.oldPassword}" class="contexttext"  id="oldPassword"
                              placeholder="Old password"   size="30" required="true"  /> 
                  <p:message for="oldPassword" id="oldPasswordMsg"  /> 

                  <p:outputLabel value="New password "  class="labeltext"  for="newPassword" />
                  <p:spacer width="10" />
                  <p:password value="#{user.newPassword}" class="contexttext" match="newPasswordConfirmPassword"  
                              placeholder="New password" id="newPassword" size="30" required="true" feedback="true" inline="true" /> 
                  <p:message for="newPassword" id="newPasswordMsg"   />  

                  <p:outputLabel value="Confirm new password" class="labeltext" for="newPasswordConfirmPassword" />
                  <p:spacer width="10" />
                  <p:password value="#{user.password}" class="contexttext"  
                              placeholder="Confirm new password" id="newPasswordConfirmPassword" size="30" required="true" />
                  <p:spacer width="10" />

                  <p:spacer width="10" />
                  <p:spacer width="10" />
                  <p:spacer width="10" />
                  <p:spacer width="10" />

                  <p:spacer width="10" />
                  <p:spacer width="10" />
                  <p:commandButton value="Submit" actionListener="#{user.updatePassword()}" update="userProfilePanel changePasswordErrorMsg" process="@this,changePasswordPanel" />
                  <p:spacer width="10" /> 
                </h:panelGrid>
              </h:panelGrid>
            </h:panelGroup> 
          </h:panelGroup> 


          <!--</h:panelGrid>-->  

        </h:form>
        <script type="text/javascript">
          function start() {
            PF('statusDialog').show();
          }

          function stop() {
            PF('statusDialog').hide();
          }

        </script>
      </ui:define>
    </ui:composition>
  </body>
</html>